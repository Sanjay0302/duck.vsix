<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="${cssUri}">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
    <div id="chat-container">
        <div id="messages"></div>
        <div id="input-container">
            <textarea id="message-input" placeholder="Type a message..." rows="1"></textarea>
            <button id="send-button">Send</button>
        </div>
    </div>
    <script>
        const vscode = acquireVsCodeApi();
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        let currentMessageDiv = null;

        function addMessage(content, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'message user-message' : 'message assistant-message';
            
            // Create message content container
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // Set the HTML content directly since it's already processed by Showdown
            contentDiv.innerHTML = content;
            
            // Add syntax highlighting to code blocks
            contentDiv.querySelectorAll('pre code').forEach((block) => {
                if (window.hljs) {
                    window.hljs.highlightElement(block);
                }
            });
            
            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return messageDiv;
        }

        function sendMessage() {
            const text = messageInput.value.trim();
            if (text) {
                vscode.postMessage({
                    command: 'sendMessage',
                    text: text
                });
                messageInput.value = '';
                adjustTextareaHeight();
            }
        }

        // Auto-resize textarea
        function adjustTextareaHeight() {
            messageInput.style.height = 'auto';
            messageInput.style.height = messageInput.scrollHeight + 'px';
        }

        messageInput.addEventListener('input', adjustTextareaHeight);

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendButton.addEventListener('click', sendMessage);

        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.command) {
                case 'receiveMessage':
                    if (message.isIncremental && currentMessageDiv) {
                        const contentDiv = currentMessageDiv.querySelector('.message-content');
                        contentDiv.innerHTML = message.text;
                    } else {
                        currentMessageDiv = addMessage(message.text, false);
                    }
                    break;
            }
        });

        // Initialize textarea height
        adjustTextareaHeight();
    </script>
</body>
</html>