<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="${cssUri}">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)']],
                displayMath: [['\\[', '\\]']],
                processEscapes: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
</head>
<body>
    <div id="chat-container">
        <div id="messages"></div>
        <div id="input-container">
            <textarea id="message-input" placeholder="Type a message..." rows="1"></textarea>
            <button id="send-button">Send</button>
        </div>
    </div>
    <script>
        const vscode = acquireVsCodeApi();
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        let currentMessageDiv = null;

        function createCodeBlock(code, language) {
            const container = document.createElement('div');
            container.className = 'code-block-container';

            const actions = document.createElement('div');
            actions.className = 'code-actions';

            const copyButton = document.createElement('button');
            copyButton.className = 'code-button';
            copyButton.textContent = 'Copy';
            copyButton.onclick = async () => {
                try {
                    await navigator.clipboard.writeText(code);
                    copyButton.textContent = 'Copied!';
                    setTimeout(() => {
                        copyButton.textContent = 'Copy';
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy:', err);
                }
            };

            const insertButton = document.createElement('button');
            insertButton.className = 'code-button';
            insertButton.textContent = 'Insert';
            insertButton.onclick = () => {
                vscode.postMessage({
                    command: 'insertCode',
                    code: code
                });
            };

            actions.appendChild(copyButton);
            actions.appendChild(insertButton);
            container.appendChild(actions);

            const pre = document.createElement('pre');
            const codeElement = document.createElement('code');
            if (language) {
                codeElement.className = `language-${language}`;
            }
            codeElement.textContent = code;
            pre.appendChild(codeElement);
            container.appendChild(pre);

            return container;
        }

        function addMessage(content, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'message user-message' : 'message assistant-message';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // First set the content
            contentDiv.innerHTML = content;
            
            // Trigger MathJax to process the new content
            if (window.MathJax) {
                window.MathJax.typesetPromise([contentDiv]).catch((err) => console.error('MathJax error:', err));
            }
            
            // Then replace code blocks with our custom ones
            contentDiv.querySelectorAll('pre code').forEach((block) => {
                const code = block.textContent;
                const language = block.className.replace('language-', '');
                const codeBlockContainer = createCodeBlock(code, language);
                block.parentElement.replaceWith(codeBlockContainer);
            });
            
            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return messageDiv;
        }

        function sendMessage() {
            const text = messageInput.value.trim();
            if (text) {
                vscode.postMessage({
                    command: 'sendMessage',
                    text: text
                });
                messageInput.value = '';
                adjustTextareaHeight();
            }
        }

        function adjustTextareaHeight() {
            messageInput.style.height = 'auto';
            messageInput.style.height = messageInput.scrollHeight + 'px';
        }

        messageInput.addEventListener('input', adjustTextareaHeight);

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendButton.addEventListener('click', sendMessage);

        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.command) {
                case 'receiveMessage':
                    if (message.isIncremental && currentMessageDiv) {
                        const contentDiv = currentMessageDiv.querySelector('.message-content');
                        contentDiv.innerHTML = message.text;
                        // Re-process code blocks after updating content
                        contentDiv.querySelectorAll('pre code').forEach((block) => {
                            const code = block.textContent;
                            const language = block.className.replace('language-', '');
                            const codeBlockContainer = createCodeBlock(code, language);
                            block.parentElement.replaceWith(codeBlockContainer);
                        });
                    } else {
                        currentMessageDiv = addMessage(message.text, false);
                    }
                    break;
            }
        });

        adjustTextareaHeight();
    </script>
</body>
</html>