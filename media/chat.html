<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="${cssUri}">
</head>
<body>
    <div id="chat-container">
        <div id="messages"></div>
        <div id="input-container">
            <input type="text" id="message-input" placeholder="Type a message...">
            <button id="send-button">Send</button>
        </div>
    </div>
    <script>
        const vscode = acquireVsCodeApi();
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        let currentMessageDiv = null;

        function createCodeBlock(code, language) {
            const container = document.createElement('div');
            container.className = 'code-block-container';
            
            const header = document.createElement('div');
            header.className = 'code-block-header';
            
            const langLabel = document.createElement('span');
            langLabel.className = 'language-label';
            langLabel.textContent = language || 'plaintext';
            
            const actions = document.createElement('div');
            actions.className = 'code-actions';
            
            const copyButton = document.createElement('button');
            copyButton.className = 'code-button';
            copyButton.textContent = 'Copy';
            copyButton.addEventListener('click', () => {
                navigator.clipboard.writeText(code).then(() => {
                    copyButton.textContent = 'Copied!';
                    setTimeout(() => copyButton.textContent = 'Copy', 2000);
                }).catch(err => console.error('Failed to copy:', err));
            });
            
            const insertButton = document.createElement('button');
            insertButton.className = 'code-button';
            insertButton.textContent = 'Insert';
            insertButton.addEventListener('click', () => {
                vscode.postMessage({
                    command: 'insertCode',
                    code: code
                });
            });
            
            actions.appendChild(copyButton);
            actions.appendChild(insertButton);
            header.appendChild(langLabel);
            header.appendChild(actions);
            
            const pre = document.createElement('pre');
            const codeElement = document.createElement('code');
            codeElement.textContent = code;
            pre.appendChild(codeElement);
            
            container.appendChild(header);
            container.appendChild(pre);
            return container;
        }

        function parseMarkdown(text) {
            // Headers
            text = text.replace(/^### (.*$)/gm, '<h3>$1</h3>');
            text = text.replace(/^## (.*$)/gm, '<h2>$1</h2>');
            text = text.replace(/^# (.*$)/gm, '<h1>$1</h1>');
            
            // Lists
            text = text.replace(/^\* (.*$)/gm, '<li>$1</li>');
            text = text.replace(/^- (.*$)/gm, '<li>$1</li>');
            text = text.replace(/^(\d+\. .*$)/gm, '<li>$1</li>');
            text = text.replace(/(<li>.*<\/li>)\n/g, '<ul>$1</ul>');
            
            // Bold and Italic
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Links
            text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');
            
            // Code blocks
            text = text.replace(/```(\w*)\n([\s\S]*?)```/g, (match, lang, code) => {
                const container = createCodeBlock(code.trim(), lang);
                const temp = document.createElement('div');
                temp.appendChild(container);
                return temp.innerHTML;
            });
            
            // Inline code
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Paragraphs
            text = text.replace(/\n\n/g, '</p><p>');
            text = '<p>' + text + '</p>';
            
            return text;
        }

        function addMessage(text, isUser, isIncremental = false) {
            if (isUser || !isIncremental || !currentMessageDiv) {
                currentMessageDiv = document.createElement('div');
                currentMessageDiv.className = `message ${isUser ? 'user-message' : 'assistant-message'}`;
                messagesDiv.appendChild(currentMessageDiv);
            }
            
            currentMessageDiv.innerHTML = parseMarkdown(text);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function sendMessage() {
            const text = messageInput.value.trim();
            if (text) {
                addMessage(text, true);
                currentMessageDiv = null; // Reset for next response
                vscode.postMessage({
                    command: 'sendMessage',
                    text: text
                });
                messageInput.value = '';
            }
        }

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendButton.addEventListener('click', sendMessage);

        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.command) {
                case 'receiveMessage':
                    addMessage(message.text, false, message.isIncremental);
                    break;
            }
        });
    </script>
</body>
</html>
